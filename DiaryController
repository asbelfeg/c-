using Diaryy.Models;
using Microsoft.AspNetCore.Mvc;

namespace Diaryy.Controllers
{
    public class DiaryController : Controller
    {
        // üíæ –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å)
        private static readonly Dictionary<int, DiaryItem> _db = new();
        private static int _nextId = 1;

        // GET /Diary/ListRows
        [HttpGet]
        public IActionResult ListRows()
        {
            var allItems = _db.Values.OrderByDescending(item => item.CreatedAt).ToList();
            return View(allItems);
        }

        // GET /Diary/GetRow/5
        [HttpGet]
        public IActionResult GetRow(int id)
        {
            if (!_db.TryGetValue(id, out var item))
            {
                TempData["Error"] = $"–ó–∞–ø–∏—Å–∏ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º '{id}' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!";
                return RedirectToAction(nameof(ListRows));
            }
            return View(item);
        }

        // GET /Diary/CreateRow
        [HttpGet]
        public IActionResult CreateRow()
        {
            return View("EditOrCreateRow", new EditDiaryModel());
        }
        
        // GET /Diary/EditRow/5
        [HttpGet]
        public IActionResult EditRow(int id)
        {
            if (!_db.TryGetValue(id, out var item))
            {
                TempData["Error"] = $"–ó–∞–ø–∏—Å–∏ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º '{id}' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!";
                return RedirectToAction(nameof(ListRows));
            }

            var model = new EditDiaryModel
            {
                Id = item.Id,
                Title = item.Title,
                Text = item.Text
            };

            return View("EditOrCreateRow", model);
        }

        // POST /Diary/EditOrCreateRow (–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ —Å–æ–∑–¥–∞–Ω–∏–µ, –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult EditOrCreateRow(EditDiaryModel model)
        {
            if (!ModelState.IsValid)
            {
                TempData["Error"] = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏!";
                return View(model);
            }

            if (model.Id == 0) // –°–æ–∑–¥–∞–Ω–∏–µ
            {
                var newId = _nextId++;
                var newItem = new DiaryItem
                {
                    Id = newId,
                    Title = model.Title,
                    Text = model.Text,
                    CreatedAt = DateTime.Now
                };

                _db[newId] = newItem;
                TempData["Success"] = $"–ó–∞–ø–∏—Å—å **{newItem.DisplayTitle}** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.";
            }
            else // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            {
                if (!_db.TryGetValue(model.Id, out var existingItem))
                {
                    TempData["Error"] = $"–û—à–∏–±–∫–∞: –ó–∞–ø–∏—Å—å —Å Id={model.Id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.";
                    return RedirectToAction(nameof(ListRows));
                }

                existingItem.Title = model.Title;
                existingItem.Text = model.Text;
                
                TempData["Success"] = $"–ó–∞–ø–∏—Å—å **{existingItem.DisplayTitle}** –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞!";
            }

            return RedirectToAction(nameof(ListRows));
        }
    }
}
